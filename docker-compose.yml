
networks:
  services:
    driver: bridge

services:
  immich_server:
    healthcheck:
      disable: false
    image: ghcr.io/immich-app/immich-server:${IMMICH_VERSION:-release}
    container_name: immich_server
    restart: unless-stopped
    command: ["start.sh", "immich"]
    volumes:
      - ${IMMICH_UPLOAD_LOCATION}:/data
      - /etc/localtime:/etc/localtime:ro
    environment:
      DB_HOSTNAME: immich_postgres
      DB_USERNAME: immich
      DB_PASSWORD: ${IMMICH_DB_PASSWORD}
      DB_DATABASE_NAME: immich
      TZ: ${TIMEZONE}
      PUBLIC_IMMICH_URL: /immich
    ports:
      - "2283:2283"
    networks:
      - services
    depends_on:
      - immich_postgres
      - immich_redis
      - immich_machine_learning
    env_file:
      - .env

  immich_machine_learning:
    healthcheck:
      disable: false
    image: ghcr.io/immich-app/immich-machine-learning:${IMMICH_VERSION:-release}
    container_name: immich_machine_learning
    restart: unless-stopped
    volumes:
      - model-cache:/cache
      - /etc/localtime:/etc/localtime:ro
    environment:
      TZ: ${TIMEZONE}
    networks:
      services:
        aliases:
          - immich-machine-learning
    env_file:
      - .env

  immich_postgres:
    image: ghcr.io/immich-app/postgres:14-vectorchord0.4.3-pgvectors0.2.0@sha256:bcf63357191b76a916ae5eb93464d65c07511da41e3bf7a8416db519b40b1c23
    container_name: immich_postgres
    restart: unless-stopped
    environment:
      POSTGRES_PASSWORD: ${IMMICH_DB_PASSWORD}
      POSTGRES_USER: ${DB_USERNAME}
      POSTGRES_DB: ${DB_DATABASE_NAME}
      POSTGRES_INITDB_ARGS: '--data-checksums'
    volumes:
      - ${IMMICH_DB_DATA_LOCATION}:/var/lib/postgresql/data
    networks:
      - services
    env_file:
      - .env

  immich_redis:
    healthcheck:
      test: redis-cli ping || exit 1
    image: docker.io/valkey/valkey:8@sha256:81db6d39e1bba3b3ff32bd3a1b19a6d69690f94a3954ec131277b9a26b95b3aa
    container_name: immich_redis
    hostname: redis
    restart: unless-stopped
    networks:
      - services

  copyparty:
    image: copyparty/ac
    container_name: copyparty
    restart: unless-stopped
    volumes:
      - ${FILES_DIR}:/files:rw
      - ${COPYPARTY_CONFIG}:/cfg:rw
    environment:
      TZ: ${TIMEZONE}
    entrypoint: []
    command:
      - python3
      - -m
      - copyparty
      - -v
      - /files::A,${COPYPARTY_USER}
      - -a
      - ${COPYPARTY_USER}:${COPYPARTY_PASS}
      - -e2dsa
      - -e2ts
      - --xff-src
      - lan
      - --xff-hdr
      - x-forwarded-for
      - --rproxy
      - "1"
    ports:
      - "3923:3923"
    networks:
      - services
    env_file:
      - .env

  gitea:
    image: gitea/gitea:latest
    container_name: gitea
    restart: unless-stopped
    volumes:
      - ${GITEA_DATA}:/data
      - /etc/localtime:/etc/localtime:ro
    environment:
      USER_UID: 1000
      USER_GID: 1000
      GITEA__server__ROOT_URL: ${GITEA__server__ROOT_URL}
      GITEA__server__DOMAIN: ${GITEA__server__DOMAIN}
      GITEA__server__SSH_DOMAIN: ${GITEA__server__SSH_DOMAIN}
      GITEA__server__SSH_PORT: ${GITEA__server__SSH_PORT}
      GITEA__database__DB_TYPE: ${GITEA__database__DB_TYPE}
      GITEA__database__PATH: ${GITEA__database__PATH}
    ports:
      - "2222:22"
      - "3000:3000"
    networks:
      - services
    env_file:
      - .env

  cloudflared-init:
    build:
      context: ./cloudflared
      dockerfile: Dockerfile.init
    container_name: cloudflared-init
    restart: "no"
    networks:
      - services
    env_file:
      - .env

  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    restart: unless-stopped
    command: tunnel --config /etc/cloudflared/config.yml run
    volumes:
      - ./cloudflared:/etc/cloudflared:rw
    networks:
      - services
    depends_on:
      - cloudflared-init
volumes:
  model-cache:
